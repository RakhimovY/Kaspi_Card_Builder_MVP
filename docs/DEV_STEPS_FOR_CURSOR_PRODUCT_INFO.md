# DEV_STEPS_FOR_CURSOR_PRODUCT_INFO.md — Расширение блока «Информация о товаре» (Kaspi)

## Цель
Добавить в Studio (правая панель) недостающие поля и UX, чтобы из одного места получить полноценный пакет для Kaspi: GTIN/штрихкод, вариативность (цвет/размер/ёмкость), атрибуты по категориям, логистику/сертификацию, RU/KZ контент, прогресс-заполненности и корректный экспорт CSV/ZIP.

## Нельзя (guardrails)
- Не писать собственные алгоритмы удаления фона (уже есть).
- Не трогать секреты/ключи на клиенте.
- Не добавлять сторонние CDN-хранилища/загрузки — остаёмся в текущей архитектуре.

---

## Изменения в БД (Prisma)
1. **ProductDraft** — убедиться/добавить поля:
   - `gtin` `String?`
   - `titleRU`/`titleKZ` `String?`
   - `descRU`/`descKZ` `String?`
   - `attributesJson` `Json?` (уже есть)
   - `variantsJson` `Json?` (новое)
2. **ImageAsset** — без изменений.
3. Миграции применить.

**DoD БД:** Prisma generate + migrate проходят; `prisma studio` открывается; create/read/update ProductDraft с новыми полями работает.

---

## API
1. `PATCH /api/product-drafts/:id` — поддержать обновление `gtin`, `titleRU/KZ`, `descRU/KZ`, `attributesJson`, `variantsJson`.
2. `GET /api/product-drafts` — вернуть новые поля в списке.
3. **Валидация**: Zod-схемы на вход/выход, понятные 400-ошибки.
4. **Квоты**: при вызовах Magic Fill/серверного экспорта вызывать `assertQuota` (готово в проекте).

**DoD API:** интеграционный тест happy-path + валидационные ошибки для PATCH.

---

## UI — Studio (правая панель)
Добавить секции (в указанном порядке):

1) **Идентификация**
   - `sku` (обяз.), автогенерация `<brand>-<model>` с ручной правкой
   - `gtin` (опц.) + кнопка **«Сканировать штрихкод»** (ZXing modal)
   - `brand` (обяз.), `type` (обяз.), `model` (опц.), `keySpec` (опц.)

2) **Контент (RU/KZ)**
   - `titleRU`, `titleKZ` (формула: `<type> <brand> <model> <keySpec>`; 60–80 символов)
   - `descRU`, `descKZ` (буллеты + «Характеристики»)
   - Кнопка **«Сгенерировать»** (вызов локальных генераторов/серверного Magic Fill)

3) **Варианты**
   - Таблица динамических строк: `variant.sku` (обяз. при наличии вариантов), `color`, `size`, `capacity`, `compat`
   - Добавить/удалить вариант, валидация уникальности `variant.sku`

4) **Атрибуты**
   - key→value[] (динамический список), пресеты по категории (Электроника/Одежда/Косметика)

5) **Логистика**
   - Вес, Габариты (Д×Ш×В), Комплектация, Гарантия, Страна происхождения, Сертификаты/ТР ТС, Электропараметры, Возрастной рейтинг
   - Хранить внутри `attributesJson`

6) **Категория и чек-лист**
   - Сохранить текущую реализацию чек-листов; добавить подсказки под незаполненные критичные поля

7) **Прогресс заполненности**
   - Индикатор (0–100%) + тултипы, какие поля ещё нужны для экспорта без ошибок

**UX/Тех:** RHF + Zod; Zustand persist; все тексты — через i18n (RU/KZ).

**DoD UI:** Вводится/редактируется всё перечисленное, сохраняется в черновик и восстанавливается после refresh.

---

## BARCODE (ZXing)
- Диалог «Сканировать штрихкод»; успешный скан → вставить `gtin` → предложить «Заполнить Magic Fill».
- Fallback: ручной ввод GTIN.

**DoD:** Скан на популярных десктоп-браузерах; корректные сообщения об ошибках.

---

## MAGIC FILL
- При наличии `gtin` и/или фото — вызывать `POST /api/magic-fill`.
- После ответа — заполнять `brand/type/model/keySpec`, `titleRU/KZ`, `descRU/KZ`, `attributesJson`, `images` (id-ссылки на локальные/загруженные).
- Сохранять/обновлять **ProductDraft**.

**DoD:** Для трёх тестовых товаров заполняется ≥80% базовых полей; кэш по GTIN работает (повторный вызов быстрее).

---

## Экспорт CSV/ZIP
- Маппинг: `name ← titleRU`, `description ← descRU`, `attributes_notes ← сериализация attributesJson`.
- Варианты: дублировать строки с разными `sku` и `image1..8` (если у варианта свой набор фото).
- Имена файлов: `<SKU>_<index>.jpg|webp`.
- Мини-валидатор перед экспортом: обязательные поля заполнены, размеры фото ОК, до 8 изображений.

**DoD:** CSV импортируется в Kaspi без ошибок на 5 тестовых кейсах.

---

## i18n
- Добавить ключи для всех новых полей/подсказок/ошибок RU/KZ (см. `UI_COPY_AND_I18N_KEYS.md`).

---

## Аналитика
- Plausible: `scan_barcode`, `magic_fill_used`, `variants_added`, `export_csv_ready`, `export_zip` (уже есть), `start_checkout`.

---

## Тесты
- Юнит: Zod-схемы формы/экспорта.
- Интеграция: PATCH drafts, magic-fill мок.
- E2E smoke: создание товара → экспорт CSV/ZIP → валидация.

---

## Definition of Done (сводно)
- БД/миграции применены; API PATCH поддерживает новые поля
- UI-форма покрывает все разделы; прогресс-бар; ZXing-сканер
- Magic Fill заполняет черновик; кэш GTIN
- Экспорт CSV/ZIP корректен, валидатор предотвращает ошибки
- RU/KZ локализации добавлены
- События аналитики отправляются